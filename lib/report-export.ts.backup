/**
 * Utilidades para exportar informes a Word y funcionalidad de impresi√≥n
 */

import {
  getStaticMapImageUrl,
  getStaticMapBase64,
  getOpenStreetMapUrl,
  getGoogleMapsUrl,
  isValidGPSCoordinates,
  formatGPSCoordinates
} from './maps-utils'

interface ReportData {
  projectData: {
    workNumber: string
    orderNumber: string
    projectName: string
    location: string
    inspector: string
    reviewer: string
    client: string
    inspectionDate: string
    reportDate: string
    introduction: string
  }
  images: Array<{
    id: string
    filename: string
    url: string
    urlWithBoxes?: string // Imagen con bounding boxes dibujados
    timestamp: string
    gps: {
      latitude: string
      longitude: string
      altitude: number
    }
    detections: Array<{
      severity: string
      confidence: number
    }>
    analysis: string
    mapImageBase64?: string | null // Imagen del mapa en base64
  }>
}

/**
 * Genera y descarga un informe en formato Word (.docx)
 */
export async function exportToWord(data: ReportData, logoBase64?: string): Promise<void> {
  try {
    // Crear el HTML del documento
    const htmlContent = generateReportHTML(data, logoBase64)

    // Crear blob con el contenido HTML en formato compatible con Word
    const blob = new Blob(
      [
        `
        <html xmlns:o='urn:schemas-microsoft-com:office:office'
              xmlns:w='urn:schemas-microsoft-com:office:word'
              xmlns='http://www.w3.org/TR/REC-html40'>
        <head>
          <meta charset='utf-8'>
          <title>Informe de Inspecci√≥n - ${data.projectData.projectName}</title>
          <style>
            @page {
              margin: 2.5cm 2cm 2cm 2cm;
            }
            body {
              font-family: Calibri, Arial, sans-serif;
              font-size: 11pt;
              line-height: 1.5;
              margin: 0;
              padding: 0;
            }
            .page-header {
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              height: 1.5cm;
              text-align: center;
              border-bottom: 1px solid #e5e7eb;
              background: white;
              z-index: 1000;
            }
            .page-header img {
              height: 1.2cm;
              margin-top: 0.15cm;
            }
            .content {
              margin-top: 2cm;
              padding: 0 2cm;
            }
            h1 {
              font-size: 18pt;
              font-weight: bold;
              color: #2563eb;
              border-bottom: 2px solid #2563eb;
              padding-bottom: 10px;
              margin-top: 20px;
            }
            h2 {
              font-size: 14pt;
              font-weight: bold;
              color: #1e40af;
              margin-top: 15px;
            }
            h3 {
              font-size: 12pt;
              font-weight: bold;
              margin-top: 10px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin: 10px 0;
            }
            td, th {
              border: 1px solid #000;
              padding: 8px;
              text-align: left;
            }
            th {
              background-color: #e5e7eb;
              font-weight: bold;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
            }
            .logo {
              max-width: 250px;
              height: auto;
              margin: 0 auto 20px auto;
              display: block;
            }
            .photo-section {
              page-break-before: always;
              margin-top: 20px;
            }
            .photo-container {
              margin: 20px 0;
              page-break-inside: avoid;
            }
            .photo-img {
              width: 100%;
              max-width: 100%;
              height: auto;
              border: 1px solid #ccc;
            }
            .map-container {
              margin: 15px 0;
              border: 1px solid #ddd;
              padding: 10px;
              background-color: #f9fafb;
            }
            .map-img {
              width: 100%;
              max-width: 600px;
              height: auto;
              border: 1px solid #ccc;
              display: block;
              margin: 10px auto;
            }
            .map-link {
              display: block;
              text-align: center;
              color: #2563eb;
              text-decoration: none;
              font-size: 10pt;
              margin-top: 5px;
              font-weight: bold;
            }
            .map-link:hover {
              text-decoration: underline;
            }
            .metadata {
              font-size: 9pt;
              color: #666;
              margin-top: 5px;
            }
            .severity-high {
              color: #dc2626;
              font-weight: bold;
            }
            .severity-medium {
              color: #f59e0b;
              font-weight: bold;
            }
            .severity-low {
              color: #10b981;
              font-weight: bold;
            }
            .footer {
              margin-top: 40px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
              font-size: 9pt;
              text-align: center;
              color: #666;
            }
          </style>
        </head>
        <body>
          ${htmlContent}
        </body>
        </html>
      `
      ],
      {
        type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
      }
    )

    // Crear enlace de descarga
    const url = URL.createObjectURL(blob)
    const link = document.createElement('a')
    link.href = url

    const fileName = `Informe_${data.projectData.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.doc`
    link.download = fileName

    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)

  } catch (error) {
    console.error('Error exporting to Word:', error)
    throw new Error('No se pudo exportar el informe a Word')
  }
}

/**
 * Genera el contenido HTML del informe
 */
function generateReportHTML(data: ReportData, logoBase64?: string): string {
  const { projectData, images } = data

  // Calcular estad√≠sticas generales
  const totalDetections = images.reduce((sum, img) => sum + img.detections.length, 0)
  const severityCounts = {
    alto: 0,
    medio: 0,
    bajo: 0
  }

  images.forEach(img => {
    img.detections.forEach(det => {
      if (det.severity === 'alto') severityCounts.alto++
      else if (det.severity === 'medio') severityCounts.medio++
      else if (det.severity === 'bajo') severityCounts.bajo++
    })
  })

  return `
    ${logoBase64 ? `
    <div class="page-header">
      <img src="${logoBase64}" alt="RDT Logo">
    </div>
    ` : ''}

    <div class="content">
      <div class="header">
        <h1>INFORME DE INSPECCI√ìN</h1>
        <h2>Detecci√≥n de Corrosi√≥n mediante IA</h2>
      </div>

      <h2>1. DATOS DEL PROYECTO</h2>
    <table>
      <tr>
        <th width="30%">Campo</th>
        <th width="70%">Valor</th>
      </tr>
      <tr>
        <td>Nombre del Proyecto</td>
        <td>${projectData.projectName}</td>
      </tr>
      <tr>
        <td>N¬∫ de Obra</td>
        <td>${projectData.workNumber}</td>
      </tr>
      <tr>
        <td>N¬∫ de Pedido</td>
        <td>${projectData.orderNumber}</td>
      </tr>
      <tr>
        <td>Cliente</td>
        <td>${projectData.client}</td>
      </tr>
      <tr>
        <td>Localizaci√≥n</td>
        <td>${projectData.location}</td>
      </tr>
      <tr>
        <td>Fecha de Inspecci√≥n</td>
        <td>${new Date(projectData.inspectionDate).toLocaleDateString('es-ES')}</td>
      </tr>
      <tr>
        <td>Fecha del Informe</td>
        <td>${new Date(projectData.reportDate).toLocaleDateString('es-ES')}</td>
      </tr>
      <tr>
        <td>Elaborado por</td>
        <td>${projectData.inspector}</td>
      </tr>
      <tr>
        <td>Revisado por</td>
        <td>${projectData.reviewer}</td>
      </tr>
    </table>

    ${projectData.introduction ? `
    <h2>2. INTRODUCCI√ìN</h2>
    <p style="text-align: justify; line-height: 1.6;">
      ${projectData.introduction.replace(/\n/g, '<br>')}
    </p>
    ` : ''}

    <h2>${projectData.introduction ? '3' : '2'}. RESUMEN EJECUTIVO</h2>
    <p>
      Se realiz√≥ una inspecci√≥n mediante captura a√©rea con dron de la estructura ubicada en ${projectData.location}.
      Las im√°genes capturadas fueron procesadas mediante sistema de visi√≥n artificial para detectar autom√°ticamente
      √°reas con presencia de corrosi√≥n.
    </p>

    <h3>${projectData.introduction ? '3.1' : '2.1'} Resultados Generales</h3>
    <table>
      <tr>
        <th>Total de Im√°genes Analizadas</th>
        <td>${images.length}</td>
      </tr>
      <tr>
        <th>Total de Detecciones</th>
        <td>${totalDetections}</td>
      </tr>
      <tr>
        <th class="severity-high">Corrosi√≥n Extensa</th>
        <td class="severity-high">${severityCounts.alto} (${((severityCounts.alto / totalDetections) * 100).toFixed(1)}%)</td>
      </tr>
      <tr>
        <th class="severity-medium">Corrosi√≥n Moderada</th>
        <td class="severity-medium">${severityCounts.medio} (${((severityCounts.medio / totalDetections) * 100).toFixed(1)}%)</td>
      </tr>
      <tr>
        <th class="severity-low">Corrosi√≥n Leve</th>
        <td class="severity-low">${severityCounts.bajo} (${((severityCounts.bajo / totalDetections) * 100).toFixed(1)}%)</td>
      </tr>
    </table>

    <div class="photo-section">
      <h2>${projectData.introduction ? '4' : '3'}. ANEXO FOTOGR√ÅFICO Y AN√ÅLISIS DETALLADO</h2>
      ${images.map((img, index) => `
        <div class="photo-container">
          <h3>Fotograf√≠a ${index + 1}: ${img.filename}</h3>

          <img src="${img.urlWithBoxes || img.url}" class="photo-img" alt="Fotograf√≠a ${index + 1}">

          <div class="metadata">
            <p><strong>Coordenadas GPS:</strong> ${formatGPSCoordinates(img.gps.latitude, img.gps.longitude, img.gps.altitude)}</p>
            <p><strong>Fecha y Hora:</strong> ${img.timestamp}</p>
          </div>

          ${isValidGPSCoordinates(img.gps.latitude, img.gps.longitude) && img.mapImageBase64 ? `
          <div class="map-container">
            <h4>üìç Ubicaci√≥n Geogr√°fica</h4>
            <img
              src="${img.mapImageBase64}"
              class="map-img"
              alt="Mapa de ubicaci√≥n"
            >
            <div style="text-align: center; margin-top: 8px;">
              <a
                href="${getOpenStreetMapUrl(img.gps.latitude, img.gps.longitude)}"
                target="_blank"
                class="map-link"
                style="margin-right: 15px;"
              >
                üó∫Ô∏è Abrir en OpenStreetMap
              </a>
              <a
                href="${getGoogleMapsUrl(img.gps.latitude, img.gps.longitude)}"
                target="_blank"
                class="map-link"
              >
                üåç Abrir en Google Maps
              </a>
            </div>
            <p style="text-align: center; font-size: 9pt; color: #666; margin-top: 5px;">
              Coordenadas: ${img.gps.latitude}, ${img.gps.longitude}
            </p>
          </div>
          ` : ''}

          <h4>Detecciones:</h4>
          <table>
            <tr>
              <th>Total Detecciones</th>
              <th>Extensa</th>
              <th>Moderada</th>
              <th>Leve</th>
            </tr>
            <tr>
              <td>${img.detections.length}</td>
              <td class="severity-high">${img.detections.filter(d => d.severity === 'alto').length}</td>
              <td class="severity-medium">${img.detections.filter(d => d.severity === 'medio').length}</td>
              <td class="severity-low">${img.detections.filter(d => d.severity === 'bajo').length}</td>
            </tr>
          </table>

          <h4>An√°lisis T√©cnico:</h4>
          <p>${img.analysis || 'Sin an√°lisis generado'}</p>
        </div>
      `).join('')}
    </div>

    <h2>${projectData.introduction ? '5' : '4'}. CONCLUSIONES Y RECOMENDACIONES</h2>
    <p>
      ${severityCounts.alto > 0
        ? `Se identificaron ${severityCounts.alto} √°rea(s) de severidad alta que requieren intervenci√≥n inmediata.`
        : 'No se identificaron √°reas de severidad alta.'}
    </p>
    <p>
      ${severityCounts.medio > 0
        ? `Se detectaron ${severityCounts.medio} √°rea(s) de severidad media, recomend√°ndose planificar mantenimiento preventivo.`
        : ''}
    </p>
    <p>
      Se recomienda realizar inspecciones peri√≥dicas mediante dron para monitorear la evoluci√≥n de las √°reas afectadas.
    </p>

    <div class="footer">
      <p>Generado por IKUSKI - Sistema de Detecci√≥n de Corrosi√≥n mediante IA</p>
      <p>Fecha de generaci√≥n: ${new Date().toLocaleDateString('es-ES')} - ${new Date().toLocaleTimeString('es-ES')}</p>
    </div>
  </div>
  `
}

/**
 * Abre el di√°logo de impresi√≥n del navegador
 * @param data Datos del reporte
 * @param logoBase64 Logo en base64 (opcional)
 * @param existingWindow Ventana ya abierta (opcional, para evitar bloqueos de popup)
 */
export function printReport(data: ReportData, logoBase64?: string, existingWindow?: Window | null): void {
  try {
    // Usar ventana existente o crear una nueva
    // Si ya existe una ventana, usarla para evitar bloqueos del navegador
    const printWindow = existingWindow || window.open('', '_blank', 'width=800,height=600')

    if (!printWindow) {
      throw new Error('No se pudo abrir la ventana de impresi√≥n. Verifica que no est√© bloqueada por el navegador.')
    }

    // Mostrar mensaje de carga mientras se genera el contenido
    printWindow.document.write(`
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Generando informe...</title>
        <style>
          body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: #f3f4f6;
          }
          .loader {
            text-align: center;
          }
          .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
          }
          @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
      </head>
      <body>
        <div class="loader">
          <div class="spinner"></div>
          <h2>Generando informe de inspecci√≥n...</h2>
          <p>Procesando ${data.images.length} im√°genes con bounding boxes</p>
          <p>Por favor espera, esto puede tomar unos momentos.</p>
        </div>
      </body>
      </html>
    `)

    // Generar el contenido HTML del informe
    const htmlContent = generateReportHTML(data, logoBase64)

    // Reemplazar el contenido con el informe completo
    setTimeout(() => {
      printWindow.document.open()
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="utf-8">
          <title>Informe de Inspecci√≥n - ${data.projectData.projectName}</title>
          <style>
            @media print {
              @page {
                size: A4;
                margin: 2cm;
              }
              body {
                font-family: Arial, sans-serif;
                font-size: 10pt;
                line-height: 1.4;
              }
              .photo-section {
                page-break-before: always;
              }
              .photo-container {
                page-break-inside: avoid;
                margin-bottom: 30px;
              }
            }
            body {
              font-family: Arial, sans-serif;
              font-size: 11pt;
              line-height: 1.5;
              margin: 20px;
            }
            h1 {
              font-size: 18pt;
              font-weight: bold;
              color: #2563eb;
              border-bottom: 2px solid #2563eb;
              padding-bottom: 10px;
              margin-top: 20px;
            }
            h2 {
              font-size: 14pt;
              font-weight: bold;
              color: #1e40af;
              margin-top: 15px;
            }
            h3 {
              font-size: 12pt;
              font-weight: bold;
              margin-top: 10px;
            }
            h4 {
              font-size: 11pt;
              font-weight: bold;
              margin-top: 8px;
            }
            table {
              width: 100%;
              border-collapse: collapse;
              margin: 10px 0;
            }
            td, th {
              border: 1px solid #000;
              padding: 8px;
              text-align: left;
            }
            th {
              background-color: #e5e7eb;
              font-weight: bold;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
            }
            .photo-img {
              width: 100%;
              max-width: 100%;
              height: auto;
              border: 1px solid #ccc;
              margin: 10px 0;
            }
            .map-container {
              margin: 15px 0;
              border: 1px solid #ddd;
              padding: 10px;
              background-color: #f9fafb;
              page-break-inside: avoid;
            }
            .map-img {
              width: 100%;
              max-width: 600px;
              height: auto;
              border: 1px solid #ccc;
              display: block;
              margin: 10px auto;
            }
            .map-link {
              display: block;
              text-align: center;
              color: #2563eb;
              text-decoration: none;
              font-size: 10pt;
              margin-top: 5px;
              font-weight: bold;
            }
            .metadata {
              font-size: 9pt;
              color: #666;
              margin: 5px 0;
            }
            .severity-high {
              color: #dc2626;
              font-weight: bold;
            }
            .severity-medium {
              color: #f59e0b;
              font-weight: bold;
            }
            .severity-low {
              color: #10b981;
              font-weight: bold;
            }
            .footer {
              margin-top: 40px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
              font-size: 9pt;
              text-align: center;
              color: #666;
            }
          </style>
        </head>
        <body>
          ${htmlContent}
        </body>
        </html>
      `)
      printWindow.document.close()

      // Esperar a que se carguen todas las im√°genes antes de imprimir
      // Con 40 fotos, necesitamos m√°s tiempo
      const imageCount = data.images.length
      const loadTime = Math.min(imageCount * 100, 5000) // M√°ximo 5 segundos

      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print()
          // Cerrar la ventana despu√©s de imprimir (o cancelar)
          printWindow.onafterprint = function() {
            printWindow.close()
          }
        }, loadTime)
      }
    }, 100) // Peque√±o delay para que se vea el mensaje de carga

  } catch (error) {
    console.error('Error printing report:', error)
    throw new Error('No se pudo imprimir el informe')
  }
}
